---
title: "Ideology Heatmaps"
author: "Julian Wills and Billy Brady"
date: "October 20, 2015"
output: html_document
---


```{r, echo=FALSE, results='hide', include=FALSE}
# load packages  --------------------------------------------------------
require(magrittr) || {install.packages("magrittr"); require(magrittr)}
require(dplyr) || {install.packages("dplyr"); require(dplyr)}
require(reshape2) || {install.packages("reshape2"); require(reshape2)}
require(ggplot2) || {install.packages("ggplot2"); require(ggplot2)}


if (grepl("^C:/",getwd())) {
  userDir <- "C:/Users/Julian/GDrive" #PC
} else {
  userDir <- "/Users/julian/GDrive" #Mac
}

setwd(paste0(userDir,"/1 Twitter Project/pythonScripts/allTweets"))
dAll <- tbl_df(read.csv("joinedRTs.csv",header=T)) %>% rename(tid=tID,rtid=rtID)

setwd(paste0(userDir,"/1 Twitter Project/pythonScripts/allTweets"))
dCjoin <- tbl_df(read.csv("joinedRTs.csv",header=T,sep=",")) %>% filter(topic=="C") %>% mutate(diffID=sqrt(abs(tID-rtID)),ex.tID=abs(tID),ex.rtID=abs(rtID))

dCjoin2 <- dCjoin %>% group_by(cond,author) %>% 
  summarise(tID=mean(tID),rtID=mean(rtID),ex.tID=mean(ex.tID),ex.rtID=mean(ex.rtID),M=mean(M),E=mean(E)) %>% 
  mutate(diffID=abs(tID-rtID))

```

#Correlations, Linear Models, and Unpacking Interactions
```{r}

# after adjusting for ideology of author, retweeters, and ideological extremity
lm(diffID ~ tID+rtID*M+rtID*E+M*E,data=dCjoin2) %>% summary() #main model

# morality plays a bigger role than emotion when it comes to ideological diversity
lm(diffID ~ tID+rtID+ex.tID*M+ex.tID*E,data=dCjoin2) %>% summary() #emo int w/ ex.tID
lm(diffID ~ tID+rtID+rtID*M+rtID*E,data=dCjoin2) %>% summary() #emo int w/ rtID
lm(diffID ~ tID+rtID+tID*M+tID*E,data=dCjoin2) %>% summary()

lm(diffID ~ ex.tID+ex.rtID*M+ex.rtID*E+M*E,data=dCjoin2) %>% summary() #huge morality interaction
lm(diffID ~ ex.tID*ex.rtID*M+ex.rtID*E+M*E,data=dCjoin2) %>% summary() #morality 3-way interaction
```

## in a moral context, emotional tweets accrue even narrower support
```{r}
ggplot(dCjoin2,aes(x=M,y=diffID,color=factor(E))) + 
  geom_smooth(method="lm")

ggplot(dCjoin2,aes(x=rtID,y=diffID,color=factor(cond))) + 
  geom_smooth(method="loess")
ggplot(dCjoin2,aes(x=tID,y=rtID,color=factor(cond))) + 
  geom_point(alpha=.1) +
  geom_smooth(method="loess")
```

## morality drives ideological clustering more than emotion (though emotion helps in nonmoral context)
```{r}
ggplot(dCjoin2,aes(x=tID,y=rtID,color=factor(E))) + 
  geom_point(alpha=.2) +
  geom_smooth(method="loess") +
  facet_grid(~M)

ggplot(dCjoin2,aes(x=tID,y=rtID,color=factor(E))) + 
  geom_point(alpha=.2) +
  geom_smooth(method="lm") +
  facet_grid(~M)
```

## narrower clusters for moral tweets, especially for liberals when they are emotional
```{r}
ggplot(dCjoin2,aes(x=rtID,y=diffID,color=factor(E))) + 
  geom_point(alpha=.1) +
  geom_smooth(method="loess") +
  facet_grid(~M)
```

## on raw data, before clustering retweeters w/ original author. Vert/Horz lines reflect active users?
```{r}
ggplot(dCjoin,aes(x=tID,y=rtID,color=factor(E))) + 
  geom_point(alpha=.2) +
  geom_smooth(method="lm") +
  facet_grid(~M)
```
## in a moral context, emotional tweets accrue even narrower support
```{r}
ggplot(dCjoin2,aes(x=M,y=diffID,color=factor(E))) + 
  geom_smooth(method="lm")
```

## political extremists retweet same ideology if tweet has moral content
```{r}
ggplot(dCjoin2,aes(x=ex.rtID,y=diffID,color=factor(M))) + 
  geom_point(alpha=.1) +
  geom_smooth(method="loess") 
ggplot(dCjoin2,aes(x=ex.rtID,y=diffID,color=factor(M))) + 
  geom_point(alpha=.1) +
  geom_smooth(method="lm")
```

## political extremists retweet same ideology if tweet has moral content
```{r}
ggplot(dCjoin2,aes(x=ex.rtID,y=diffID,color=factor(M))) + 
  geom_point(alpha=.1) +
  geom_smooth(method="loess") 
ggplot(dCjoin2,aes(x=ex.rtID,y=diffID,color=factor(M))) + 
  geom_point(alpha=.1) +
  geom_smooth(method="lm")
```

## more extremism (author and retweeter) when content is moral 
```{r}
ggplot(dCjoin2,aes(x=ex.rtID,y=ex.tID,color=factor(M))) + 
  geom_smooth(method="loess") 
ggplot(dCjoin2,aes(x=ex.rtID,y=ex.tID,color=factor(M))) + 
  geom_smooth(method="lm")
```



#Code for heatmaps
```{r}
# Heat maps ---------------------------------------------------------------

## functions to construct heatmaps
min <- -3.5
max <- 3.5
breaks <- 0.25

expand_data <- function(df, breaks=0.10, min=-4, max=4){
  x <- df$rtid %>% as.numeric()
  y <- df$tid %>% as.numeric()
  x <- (round((x - min) / breaks, 0) * breaks) + min
  y <- (round((y - min) / breaks, 0) * breaks) + min
  tab <- table(x, y)
  tab <- melt(tab)
  tab$prop <- tab$value/sum(tab$value)
  return(tab)
}

ideoHeatMap <- function(df) { 
  new.xy.me <- expand_data(df %>% filter(cond=="ME"),breaks=0.25) %>%  mutate(cond="ME")
  new.xy.nme <- expand_data(df %>% filter(cond=="NME"),breaks=0.25) %>% mutate(cond="NME")
  new.xy.mne <- expand_data(df %>% filter(cond=="MNE"),breaks=0.25) %>% mutate(cond="MNE")
  new.xy.nmne <- expand_data(df %>% filter(cond=="NMNE"),breaks=0.25) %>%  mutate(cond="NMNE")
  return (rbind(new.xy.me,new.xy.nme,new.xy.mne,new.xy.nmne))
}
```

#Ideology plots 

```{r, echo=FALSE}
# create heatmap
ggplot(ideoHeatMap(dAll %>% filter(topic=="G")), aes(x=y, y=x)) +
  geom_tile(aes(fill=prop), colour="white") +
  scale_fill_gradient(name="% of\ntweets", 
                      low = "white", high = "black", 
                      breaks=c(0, .0050, 0.010, 0.015, 0.02), limits=c(0, .021),
                      labels=c("0.0%", "0.5%", "1.0%", "1.5%", ">2%")) +
  labs(y="Estimated Ideology of Retweeter", x="Estimated Ideology of Author",
       title="Ideological Correlations in Gun Tweets") + 
  scale_y_continuous(expand=c(0,0), breaks=(-2:2), limits=c(-3, 3)) +
  scale_x_continuous(expand=c(0,0), breaks=(-2:2), limits=c(-3, 3)) +
  theme(panel.border=element_rect(fill=NA), panel.background = element_blank()) +
  coord_equal()  +
  facet_wrap(~ cond)

# create heatmap
ggplot(ideoHeatMap(dAll %>% filter(topic=="M")), aes(x=y, y=x)) +
  geom_tile(aes(fill=prop), colour="white") +
  scale_fill_gradient(name="% of\ntweets", 
                      low = "white", high = "black", 
                      breaks=c(0, .0050, 0.010, 0.015, 0.02), limits=c(0, .021),
                      labels=c("0.0%", "0.5%", "1.0%", "1.5%", ">2%")) +
  labs(y="Estimated Ideology of Retweeter", x="Estimated Ideology of Author",
       title="Ideological Correlations in Marriage Tweets") + 
  scale_y_continuous(expand=c(0,0), breaks=(-2:2), limits=c(-3, 3)) +
  scale_x_continuous(expand=c(0,0), breaks=(-2:2), limits=c(-3, 3)) +
  theme(panel.border=element_rect(fill=NA), panel.background = element_blank()) +
  coord_equal()  +
  facet_wrap(~ cond)

# create heatmap
ggplot(ideoHeatMap(dAll %>% filter(topic=="C")), aes(x=y, y=x)) +
  geom_tile(aes(fill=prop), colour="white") +
  scale_fill_gradient(name="% of\ntweets", 
                      low = "white", high = "black", 
                      breaks=c(0, .0050, 0.010, 0.015, 0.02), limits=c(0, .021),
                      labels=c("0.0%", "0.5%", "1.0%", "1.5%", ">2%")) +
  labs(y="Estimated Ideology of Retweeter", x="Estimated Ideology of Author",
       title="Ideological Correlations in Climate Tweets") + 
  scale_y_continuous(expand=c(0,0), breaks=(-2:2), limits=c(-3, 3)) +
  scale_x_continuous(expand=c(0,0), breaks=(-2:2), limits=c(-3, 3)) +
  theme(panel.border=element_rect(fill=NA), panel.background = element_blank()) +
  coord_equal()  +
  facet_wrap(~ cond)

dAll %>% filter(topic=="C") %>% group_by(cond) %>% summarise_each(funs(mean,sd),tid:rtid) %>% 
  mutate_each(funs(round(.,2)),tid_mean:rtid_sd)

# Incomplete data ---------------------------------------------------------
setwd("C:/Users/Julian/GDrive/1 Twitter Project/pythonScripts/")
dGM <- tbl_df(read.csv(paste0(getwd(),"/","GayMarriage/gayMarriageMoral/","joinedRTs.csv"),header=T)) %>%      rename(tid=tID,rtid=rtID)
dGC <- tbl_df(read.csv(paste0(getwd(),"/","GunControl/GC2013/","joinedRTs.csv"),header=T)) %>%                 rename(tid=tID,rtid=rtID)


# create heatmap
ggplot(ideoHeatMap(dGC %>% filter(M==1)), aes(x=y, y=x)) +
  geom_tile(aes(fill=prop), colour="white") +
  scale_fill_gradient(name="% of\ntweets", 
                      low = "white", high = "black", 
                      breaks=c(0, .0050, 0.010, 0.015, 0.02), limits=c(0, .021),
                      labels=c("0.0%", "0.5%", "1.0%", "1.5%", ">2%")) +
  labs(y="Estimated Ideology of Retweeter", x="Estimated Ideology of Author",
       title="Ideological Correlations in Gun Control 2013 Tweets") + 
  scale_y_continuous(expand=c(0,0), breaks=(-2:2), limits=c(-3, 3)) +
  scale_x_continuous(expand=c(0,0), breaks=(-2:2), limits=c(-3, 3)) +
  theme(panel.border=element_rect(fill=NA), panel.background = element_blank()) +
  coord_equal()  +
  facet_grid(. ~ cond)

dGC %>% group_by(cond) %>% filter(M==1) %>% summarise_each(funs(mean,sd),tid:rtid) %>% 
  mutate_each(funs(round(.,2)),tid_mean:rtid_sd)

# create heatmap
ggplot(ideoHeatMap(dGM %>% filter(M==1)), aes(x=y, y=x)) +
  geom_tile(aes(fill=prop), colour="white") +
  scale_fill_gradient(name="% of\ntweets", 
                      low = "white", high = "black", 
                      breaks=c(0, .0050, 0.010, 0.015, 0.02), limits=c(0, .021),
                      labels=c("0.0%", "0.5%", "1.0%", "1.5%", ">2%")) +
  labs(y="Estimated Ideology of Retweeter", x="Estimated Ideology of Author",
       title="Ideological Correlations in Gay Marriage Tweets") + 
  scale_y_continuous(expand=c(0,0), breaks=(-2:2), limits=c(-3, 3)) +
  scale_x_continuous(expand=c(0,0), breaks=(-2:2), limits=c(-3, 3)) +
  theme(panel.border=element_rect(fill=NA), panel.background = element_blank()) +
  coord_equal()  +
  facet_grid(. ~ cond)

dGM %>% group_by(cond) %>% filter(M==1) %>% summarise_each(funs(mean,sd),tid:rtid) %>% 
  mutate_each(funs(round(.,2)),tid_mean:rtid_sd)


# old code
# load in RT summary files
# setwd("C:/Users/Julian/GDrive/1 Twitter Project/pythonScripts/")
# dG <- tbl_df(read.csv(paste0(getwd(),"/","GunControl/Guns/split/filt/RT/","G_RT.csv"),header=T))
# dM <- tbl_df(read.csv(paste0(getwd(),"/","GayMarriage/marriage/split/RT/","M_RT.csv"),header=T))
# dC <- tbl_df(read.csv(paste0(getwd(),"/","ClimateChange/Combined/split/filt/append/RT/",
#                              "C_RT.csv"),header=T))
# dAll <- rbind(dG,dM,dC)
```

